    ##comienzo Template
  apiVersion: v1
  kind: Template
  metadata:
    name: ejbca-s2i-mvilche
    labels:
      template: ejbca-s2i-mvilche
      autor: "Martin_Fabrizzio_Vilche"
    annotations:
      openshift.io/display-name: "ejbca-s2i-mvilche"
      iconClass: "icon-wildfly"
      description: >-
        ejbca s2i images + openjdk + ant + jolokia
      openshift.io/provider-display-name: "Martin Fabrizzio Vilche"
      openshift.io/documentation-url: "https://github.com/mvilche/wildfly-s2i.git"
      openshift.io/support-url: "https://github.com/mvilche/wildfly-s2i.git"
  message: >-
    Eliga la version de Wildfly y Openjdk que desea utilizar
    La conexion a la base de datos podra ser realizada en el standalone.xml disponible en los configmaps

  objects:

  - apiVersion: v1
    kind: DeploymentConfig
    metadata:
      labels:
        app: "${APP_NAME}"
      name: "${APP_NAME}"
    spec:
      replicas: 1
      revisionHistoryLimit: 10
      selector:
        app: ${APP_NAME}
        deploymentconfig: ${APP_NAME}
      strategy:
        activeDeadlineSeconds: 21600
        resources: {}
        rollingParams:
          intervalSeconds: 1
          maxSurge: 25%
          maxUnavailable: 25%
          timeoutSeconds: 600
          updatePeriodSeconds: 1
        type: Rolling
      template:
        metadata:
          labels:
            app: ${APP_NAME}
            deploymentconfig: ${APP_NAME}
        spec:
          containers:
            - image: "${APP_NAME}:latest"
              imagePullPolicy: Always
              name: ${APP_NAME}
              ports:
                - containerPort: 8080
                  protocol: TCP
                - containerPort: 8778
                  protocolo: TCP
                  name: jolokia
                - containerPort: 8443
                  protocolo: TCP
                  name: https
                - containerPort: 8009
                  protocolo: TCP
                  name: ajp
                - containerPort: 8442
                  protocolo: TCP
                  name: priv                                                        
              livenessProbe:
                failureThreshold: 3
                initialDelaySeconds: 60
                periodSeconds: 20
                successThreshold: 1
                httpGet:
                  port: 8080
                  path: /
                timeoutSeconds: 15
              readinessProbe:
                failureThreshold: 3
                initialDelaySeconds: 60
                periodSeconds: 20
                successThreshold: 1
                httpGet:
                  port: 8080
                  path: /
                timeoutSeconds: 15
              resources:
                requests:
                  cpu: 500m
                  memory: 1Gi
                limits:
                  cpu: 1
                  memory: 2Gi
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
              volumeMounts:
                - mountPath: /opt/wildfly/standalone/configuration/custom/
                  name: configmap-1
                - name: ejbca-config
                  mountPath: /opt/ejbca/p12
                  subPath: ejbca-data-p12
                - mountPath: /opt/wildfly/standalone/configuration/keystore
                  name: ejbca-config
                  subPath: wildfly-keystore
          dnsPolicy: ClusterFirst
          restartPolicy: Always
          schedulerName: default-scheduler
          terminationGracePeriodSeconds: 30
          volumes:
            - configMap:
                defaultMode: 420
                items:
                  - key: standalone.xml
                    path: standalone.xml
                  - key: standalone.conf
                    path: standalone.conf
                name: wildfly-config-${APP_NAME}
              name: configmap-1
            - name: ejbca-config
              persistentVolumeClaim:
                claimName: ejbca-data                          
      test: false
      triggers:
        - type: ConfigChange
        - imageChangeParams:
            automatic: true
            containerNames:
              - ${APP_NAME}
            from:
              kind: ImageStreamTag
              name: "${APP_NAME}:latest"
          type: ImageChange


  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      finalizers:
      - kubernetes.io/pvc-protection
      name: ejbca-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi          

  - apiVersion: v1
    kind: BuildConfig
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}-s2i
    spec:
      completionDeadlineSeconds: 1800
      failedBuildsHistoryLimit: 5
      nodeSelector: null
      output:
        to:
          kind: ImageStreamTag
          name: ${APP_NAME}:latest
      postCommit: {}
      resources: {}
      runPolicy: Serial
      source:
        git:
          uri: ${REPO_GIT}
          ref: ${BRANCH_GIT}
        type: Git
      strategy:
        sourceStrategy:
          incremental: true
          from:
            kind: ImageStreamTag
            name: wildfly-14-s2i:latest
        type: Source
      successfulBuildsHistoryLimit: 5
      triggers:
        - type: ConfigChange
        - imageChange:
            from:
              kind: "ImageStreamTag"
              name: "wildfly-14-s2i:latest"        






  - apiVersion: v1
    kind: Service
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}
    spec:
      ports:
        - name: http
          port: 8080
          protocol: TCP
          targetPort: 8080
        - name: jolokia
          port: 8778
          protocol: TCP
          targetPort: 8778
        - name: ajp
          port: 8009
          protocol: TCP
          targetPort: 8009
        - name: https
          port: 8443
          protocol: TCP
          targetPort: 8443
        - name: priv
          port: 8442
          protocol: TCP
          targetPort: 8442                  
      selector:
        app: ${APP_NAME}
        deploymentconfig: ${APP_NAME}
      sessionAffinity: None
      type: ClusterIP


  - apiVersion: v1
    kind: Route
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}-http
    spec:
      port:
        targetPort: http
      to:
        kind: Service
        name: ${APP_NAME}
        weight: 100
      wildcardPolicy: None



  - apiVersion: v1
    kind: Route
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}-https
    spec:
      port:
        targetPort: https
      tls:
        insecureEdgeTerminationPolicy: Redirect
        termination: passthrough        
      to:
        kind: Service 
        name: ${APP_NAME}
        weight: 100
      wildcardPolicy: None      


  - apiVersion: v1
    kind: ImageStream
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}
    spec: {}

  - apiVersion: v1
    kind: ImageStream
    metadata:
      labels:
        app: ${APP_NAME}
      name: ${APP_NAME}-s2i
    spec: {}


######
  - apiVersion: v1
    kind: BuildConfig
    metadata:
      labels:
        app: ${APP_NAME}
        build: wildfly-14-s2i
      name: wildfly-14-s2i
    spec:
      failedBuildsHistoryLimit: 5
      nodeSelector: null
      output:
        to:
          kind: ImageStreamTag
          name: 'wildfly-14-s2i:latest'
      postCommit: {}
      resources: {}
      runPolicy: Serial
      source:
        contextDir: openjdk8
        git:
          ref: master
          uri: 'https://github.com/mvilche/ejbca-s2i-openshift.git'
        type: Git
      strategy:
        dockerStrategy:
          dockerfilePath: Dockerfile.jdk
        type: Docker
      successfulBuildsHistoryLimit: 5
      triggers:
        - type: ConfigChange


  - apiVersion: v1
    kind: ImageStream
    metadata:
      labels:
        app: ${APP_NAME}
      name: wildfly-14-s2i
    spec: {}


  - apiVersion: v1
    data:
      standalone.conf: |-
        if [ "x$JBOSS_MODULES_SYSTEM_PKGS" = "x" ]; then
          JBOSS_MODULES_SYSTEM_PKGS="org.jboss.byteman"
        fi
        if [ "x$JAVA_OPTS" = "x" ]; then

          if [ "$OPENJDK" == 8 ]; then
          JAVA_OPTS="-XX:MaxRAMFraction=1 -XX:+UnlockExperimentalVMOptions -javaagent:/usr/libexec/s2i/jolokia-jvm-1.6.2-agent.jar=host=0.0.0.0,protocol=https,keystore=$JBOSS_HOME/jolokia.jks,keystorePassword=password -Dfile.encoding=UTF8 -XX:+ExitOnOutOfMemoryError -Djava.net.preferIPv4Stack=true"
          JAVA_OPTS="$JAVA_OPTS -Djboss.modules.system.pkgs=$JBOSS_MODULES_SYSTEM_PKGS -Djava.awt.headless=true"
          fi

          if [ "$OPENJDK" == 11 ]; then
          JAVA_OPTS="-javaagent:/usr/libexec/s2i/jolokia-jvm-1.6.2-agent.jar=host=0.0.0.0,protocol=https,keystore=$JBOSS_HOME/jolokia.jks,keystorePassword=password -Dfile.encoding=UTF8 -XX:+ExitOnOutOfMemoryError -Djava.net.preferIPv4Stack=true"
          JAVA_OPTS="$JAVA_OPTS -Djboss.modules.system.pkgs=$JBOSS_MODULES_SYSTEM_PKGS -Djava.awt.headless=true"
          fi

        else
          echo "JAVA_OPTS already set in environment; overriding default settings with values: $JAVA_OPTS"
        fi
      standalone.xml: |-
        <?xml version='1.0' encoding='UTF-8'?>

        <server xmlns="urn:jboss:domain:8.0">
            <extensions>
                <extension module="org.jboss.as.clustering.infinispan"/>
                <extension module="org.jboss.as.connector"/>
                <extension module="org.jboss.as.deployment-scanner"/>
                <extension module="org.jboss.as.ee"/>
                <extension module="org.jboss.as.ejb3"/>
                <extension module="org.jboss.as.jaxrs"/>
                <extension module="org.jboss.as.jpa"/>
                <extension module="org.jboss.as.jsf"/>
                <extension module="org.jboss.as.logging"/>
                <extension module="org.jboss.as.mail"/>
                <extension module="org.jboss.as.naming"/>
                <extension module="org.jboss.as.remoting"/>
                <extension module="org.jboss.as.security"/>
                <extension module="org.jboss.as.transactions"/>
                <extension module="org.jboss.as.webservices"/>
                <extension module="org.jboss.as.weld"/>
                <extension module="org.wildfly.extension.batch.jberet"/>
                <extension module="org.wildfly.extension.bean-validation"/>
                <extension module="org.wildfly.extension.core-management"/>
                <extension module="org.wildfly.extension.discovery"/>
                <extension module="org.wildfly.extension.elytron"/>
                <extension module="org.wildfly.extension.io"/>
                <extension module="org.wildfly.extension.request-controller"/>
                <extension module="org.wildfly.extension.security.manager"/>
                <extension module="org.wildfly.extension.undertow"/>
            </extensions>
            <system-properties>
                <property name="org.apache.catalina.connector.URI_ENCODING" value="UTF-8"/>
                <property name="org.apache.catalina.connector.USE_BODY_ENCODING_FOR_QUERY_STRING" value="true"/>
                <property name="org.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH" value="true"/>
                <property name="org.apache.tomcat.util.http.Parameters.MAX_COUNT" value="2048"/>
                <property name="org.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH" value="true"/>
            </system-properties>
            <management>
                <security-realms>
                    <security-realm name="ManagementRealm">
                        <authentication>
                            <local default-user="$local" skip-group-loading="true"/>
                            <properties path="mgmt-users.properties" relative-to="jboss.server.config.dir"/>
                        </authentication>
                        <authorization map-groups-to-roles="false">
                            <properties path="mgmt-groups.properties" relative-to="jboss.server.config.dir"/>
                        </authorization>
                    </security-realm>
                    <security-realm name="ApplicationRealm">
                        <server-identities>
                            <ssl>
                                <keystore path="application.keystore" relative-to="jboss.server.config.dir" keystore-password="password" alias="server" key-password="password" generate-self-signed-certificate-host="localhost"/>
                            </ssl>
                        </server-identities>
                        <authentication>
                            <local default-user="$local" allowed-users="*" skip-group-loading="true"/>
                            <properties path="application-users.properties" relative-to="jboss.server.config.dir"/>
                        </authentication>
                        <authorization>
                            <properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                        </authorization>
                    </security-realm>
                </security-realms>
                <audit-log>
                    <formatters>
                        <json-formatter name="json-formatter"/>
                    </formatters>
                    <handlers>
                        <file-handler name="file" formatter="json-formatter" path="audit-log.log" relative-to="jboss.server.data.dir"/>
                    </handlers>
                    <logger log-boot="true" log-read-only="false" enabled="false">
                        <handlers>
                            <handler name="file"/>
                        </handlers>
                    </logger>
                </audit-log>
                <management-interfaces>
                    <http-interface security-realm="ManagementRealm" console-enabled="false">
                        <http-upgrade enabled="true"/>
                        <socket-binding http="management-http"/>
                    </http-interface>
                </management-interfaces>
                <access-control provider="simple">
                    <role-mapping>
                        <role name="SuperUser">
                            <include>
                                <user name="$local"/>
                            </include>
                        </role>
                    </role-mapping>
                </access-control>
            </management>
            <profile>
                <subsystem xmlns="urn:jboss:domain:logging:6.0">
                    <console-handler name="CONSOLE">
                        <level name="INFO"/>
                        <formatter>
                            <named-formatter name="COLOR-PATTERN"/>
                        </formatter>
                    </console-handler>
                    <periodic-rotating-file-handler name="FILE" autoflush="true">
                        <formatter>
                            <named-formatter name="PATTERN"/>
                        </formatter>
                        <file relative-to="jboss.server.log.dir" path="server.log"/>
                        <suffix value=".yyyy-MM-dd"/>
                        <append value="true"/>
                    </periodic-rotating-file-handler>
                    <logger category="com.arjuna">
                        <level name="WARN"/>
                    </logger>
                    <logger category="org.jboss.as.config">
                        <level name="DEBUG"/>
                    </logger>
                    <logger category="sun.rmi">
                        <level name="WARN"/>
                    </logger>
                    <logger category="org.ejbca">
                        <level name="INFO"/>
                    </logger>
                    <logger category="org.cesecore">
                        <level name="INFO"/>
                    </logger>
                    <root-logger>
                        <level name="INFO"/>
                        <handlers>
                            <handler name="CONSOLE"/>
                            <handler name="FILE"/>
                        </handlers>
                    </root-logger>
                    <formatter name="PATTERN">
                        <pattern-formatter pattern="%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%e%n"/>
                    </formatter>
                    <formatter name="COLOR-PATTERN">
                        <pattern-formatter pattern="%K{level}%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%e%n"/>
                    </formatter>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:batch-jberet:2.0">
                    <default-job-repository name="in-memory"/>
                    <default-thread-pool name="batch"/>
                    <job-repository name="in-memory">
                        <in-memory/>
                    </job-repository>
                    <thread-pool name="batch">
                        <max-threads count="10"/>
                        <keepalive-time time="30" unit="seconds"/>
                    </thread-pool>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:bean-validation:1.0"/>
                <subsystem xmlns="urn:jboss:domain:core-management:1.0"/>
                <subsystem xmlns="urn:jboss:domain:datasources:5.0">
                    <datasources>
                        <datasource jndi-name="java:/EjbcaDS" pool-name="ejbcads" use-ccm="true">
                            <connection-url>jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}</connection-url>
                            <driver-class>org.postgresql.Driver</driver-class>
                            <driver>postgresql.jar</driver>
                            <transaction-isolation>TRANSACTION_READ_COMMITTED</transaction-isolation>
                            <pool>
                                <min-pool-size>5</min-pool-size>
                                <max-pool-size>150</max-pool-size>
                                <prefill>true</prefill>
                            </pool>
                            <security>
                                <user-name>${POSTGRES_USER}</user-name>
                                <password>${POSTGRES_PASSWORD}</password>
                            </security>
                            <validation>
                                <check-valid-connection-sql>select 1;</check-valid-connection-sql>
                                <validate-on-match>true</validate-on-match>
                                <background-validation>false</background-validation>
                            </validation>
                            <statement>
                                <prepared-statement-cache-size>50</prepared-statement-cache-size>
                                <share-prepared-statements>true</share-prepared-statements>
                            </statement>
                        </datasource>
                        <drivers>
                            <driver name="h2" module="com.h2database.h2">
                                <xa-datasource-class>org.h2.jdbcx.JdbcDataSource</xa-datasource-class>
                            </driver>
                        </drivers>
                    </datasources>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:deployment-scanner:2.0">
                    <deployment-scanner path="deployments" relative-to="jboss.server.base.dir" scan-interval="5" runtime-failure-causes-rollback="${jboss.deployment.scanner.rollback.on.failure:false}"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:discovery:1.0"/>
                <subsystem xmlns="urn:jboss:domain:ee:4.0">
                    <spec-descriptor-property-replacement>false</spec-descriptor-property-replacement>
                    <concurrent>
                        <context-services>
                            <context-service name="default" jndi-name="java:jboss/ee/concurrency/context/default" use-transaction-setup-provider="true"/>
                        </context-services>
                        <managed-thread-factories>
                            <managed-thread-factory name="default" jndi-name="java:jboss/ee/concurrency/factory/default" context-service="default"/>
                        </managed-thread-factories>
                        <managed-executor-services>
                            <managed-executor-service name="default" jndi-name="java:jboss/ee/concurrency/executor/default" context-service="default" hung-task-threshold="60000" keepalive-time="5000"/>
                        </managed-executor-services>
                        <managed-scheduled-executor-services>
                            <managed-scheduled-executor-service name="default" jndi-name="java:jboss/ee/concurrency/scheduler/default" context-service="default" hung-task-threshold="60000" keepalive-time="3000"/>
                        </managed-scheduled-executor-services>
                    </concurrent>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:ejb3:5.0">
                    <session-bean>
                        <stateless>
                            <bean-instance-pool-ref pool-name="slsb-strict-max-pool"/>
                        </stateless>
                        <stateful default-access-timeout="5000" cache-ref="simple" passivation-disabled-cache-ref="simple"/>
                        <singleton default-access-timeout="5000"/>
                    </session-bean>
                    <pools>
                        <bean-instance-pools>
                            <strict-max-pool name="mdb-strict-max-pool" derive-size="from-cpu-count" instance-acquisition-timeout="5" instance-acquisition-timeout-unit="MINUTES"/>
                            <strict-max-pool name="slsb-strict-max-pool" derive-size="from-worker-pools" instance-acquisition-timeout="5" instance-acquisition-timeout-unit="MINUTES"/>
                        </bean-instance-pools>
                    </pools>
                    <caches>
                        <cache name="simple"/>
                    </caches>
                    <async thread-pool-name="default"/>
                    <timer-service thread-pool-name="default" default-data-store="default-file-store">
                        <data-stores>
                            <file-data-store name="default-file-store" path="timer-service-data" relative-to="jboss.server.data.dir"/>
                        </data-stores>
                    </timer-service>
                    <remote connector-ref="http-remoting-connector" thread-pool-name="default">
                        <channel-creation-options>
                            <option name="READ_TIMEOUT" value="${prop.remoting-connector.read.timeout:20}" type="xnio"/>
                            <option name="MAX_OUTBOUND_MESSAGES" value="1234" type="remoting"/>
                        </channel-creation-options>
                    </remote>
                    <thread-pools>
                        <thread-pool name="default">
                            <max-threads count="10"/>
                            <keepalive-time time="100" unit="milliseconds"/>
                        </thread-pool>
                    </thread-pools>
                    <default-security-domain value="other"/>
                    <default-missing-method-permissions-deny-access value="true"/>
                    <log-system-exceptions value="true"/>
                </subsystem>
                <subsystem xmlns="urn:wildfly:elytron:4.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto">
                    <providers>
                        <aggregate-providers name="combined-providers">
                            <providers name="elytron"/>
                            <providers name="openssl"/>
                        </aggregate-providers>
                        <provider-loader name="elytron" module="org.wildfly.security.elytron"/>
                        <provider-loader name="openssl" module="org.wildfly.openssl"/>
                    </providers>
                    <audit-logging>
                        <file-audit-log name="local-audit" path="audit.log" relative-to="jboss.server.log.dir" format="JSON"/>
                    </audit-logging>
                    <security-domains>
                        <security-domain name="ApplicationDomain" default-realm="ApplicationRealm" permission-mapper="default-permission-mapper">
                            <realm name="ApplicationRealm" role-decoder="groups-to-roles"/>
                            <realm name="local"/>
                        </security-domain>
                        <security-domain name="ManagementDomain" default-realm="ManagementRealm" permission-mapper="default-permission-mapper">
                            <realm name="ManagementRealm" role-decoder="groups-to-roles"/>
                            <realm name="local" role-mapper="super-user-mapper"/>
                        </security-domain>
                    </security-domains>
                    <security-realms>
                        <identity-realm name="local" identity="$local"/>
                        <properties-realm name="ApplicationRealm">
                            <users-properties path="application-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="ApplicationRealm"/>
                            <groups-properties path="application-roles.properties" relative-to="jboss.server.config.dir"/>
                        </properties-realm>
                        <properties-realm name="ManagementRealm">
                            <users-properties path="mgmt-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="ManagementRealm"/>
                            <groups-properties path="mgmt-groups.properties" relative-to="jboss.server.config.dir"/>
                        </properties-realm>
                    </security-realms>
                    <mappers>
                        <simple-permission-mapper name="default-permission-mapper" mapping-mode="first">
                            <permission-mapping>
                                <principal name="anonymous"/>
                                <permission-set name="default-permissions"/>
                            </permission-mapping>
                            <permission-mapping match-all="true">
                                <permission-set name="login-permission"/>
                                <permission-set name="default-permissions"/>
                            </permission-mapping>
                        </simple-permission-mapper>
                        <constant-realm-mapper name="local" realm-name="local"/>
                        <simple-role-decoder name="groups-to-roles" attribute="groups"/>
                        <constant-role-mapper name="super-user-mapper">
                            <role name="SuperUser"/>
                        </constant-role-mapper>
                    </mappers>
                    <permission-sets>
                        <permission-set name="login-permission">
                            <permission class-name="org.wildfly.security.auth.permission.LoginPermission"/>
                        </permission-set>
                        <permission-set name="default-permissions">
                            <permission class-name="org.wildfly.extension.batch.jberet.deployment.BatchPermission" module="org.wildfly.extension.batch.jberet" target-name="*"/>
                            <permission class-name="org.wildfly.transaction.client.RemoteTransactionPermission" module="org.wildfly.transaction.client"/>
                            <permission class-name="org.jboss.ejb.client.RemoteEJBPermission" module="org.jboss.ejb-client"/>
                        </permission-set>
                    </permission-sets>
                    <http>
                        <http-authentication-factory name="management-http-authentication" security-domain="ManagementDomain" http-server-mechanism-factory="global">
                            <mechanism-configuration>
                                <mechanism mechanism-name="DIGEST">
                                    <mechanism-realm realm-name="ManagementRealm"/>
                                </mechanism>
                            </mechanism-configuration>
                        </http-authentication-factory>
                        <provider-http-server-mechanism-factory name="global"/>
                    </http>
                    <sasl>
                        <sasl-authentication-factory name="application-sasl-authentication" sasl-server-factory="configured" security-domain="ApplicationDomain">
                            <mechanism-configuration>
                                <mechanism mechanism-name="JBOSS-LOCAL-USER" realm-mapper="local"/>
                                <mechanism mechanism-name="DIGEST-MD5">
                                    <mechanism-realm realm-name="ApplicationRealm"/>
                                </mechanism>
                            </mechanism-configuration>
                        </sasl-authentication-factory>
                        <sasl-authentication-factory name="management-sasl-authentication" sasl-server-factory="configured" security-domain="ManagementDomain">
                            <mechanism-configuration>
                                <mechanism mechanism-name="JBOSS-LOCAL-USER" realm-mapper="local"/>
                                <mechanism mechanism-name="DIGEST-MD5">
                                    <mechanism-realm realm-name="ManagementRealm"/>
                                </mechanism>
                            </mechanism-configuration>
                        </sasl-authentication-factory>
                        <configurable-sasl-server-factory name="configured" sasl-server-factory="elytron">
                            <properties>
                                <property name="wildfly.sasl.local-user.default-user" value="$local"/>
                            </properties>
                        </configurable-sasl-server-factory>
                        <mechanism-provider-filtering-sasl-server-factory name="elytron" sasl-server-factory="global">
                            <filters>
                                <filter provider-name="WildFlyElytron"/>
                            </filters>
                        </mechanism-provider-filtering-sasl-server-factory>
                        <provider-sasl-server-factory name="global"/>
                    </sasl>
                    <tls>
                        <key-stores>
                            <key-store name="httpsKS">
                                <credential-reference clear-text="serverpwd"/>
                                <implementation type="JKS"/>
                                <file path="keystore/keystore.jks" relative-to="jboss.server.config.dir"/>
                            </key-store>
                            <key-store name="httpsTS">
                                <credential-reference clear-text="changeit"/>
                                <implementation type="JKS"/>
                                <file path="keystore/truststore.jks" relative-to="jboss.server.config.dir"/>
                            </key-store>
                        </key-stores>
                        <key-managers>
                            <key-manager name="httpsKM" algorithm="SunX509" key-store="httpsKS">
                                <credential-reference clear-text="serverpwd"/>
                            </key-manager>
                        </key-managers>
                        <trust-managers>
                            <trust-manager name="httpsTM" key-store="httpsTS"/>
                        </trust-managers>
                        <server-ssl-contexts>
                            <server-ssl-context name="httpspub" protocols="TLSv1.2" key-manager="httpsKM"/>
                            <server-ssl-context name="httpspriv" protocols="TLSv1.2" want-client-auth="true" need-client-auth="true" authentication-optional="false" key-manager="httpsKM" trust-manager="httpsTM"/>
                        </server-ssl-contexts>
                    </tls>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:infinispan:7.0">
                    <cache-container name="hibernate" module="org.infinispan.hibernate-cache">
                        <local-cache name="entity">
                            <transaction mode="NON_XA"/>
                            <object-memory size="10000"/>
                            <expiration max-idle="100000"/>
                        </local-cache>
                        <local-cache name="local-query">
                            <object-memory size="10000"/>
                            <expiration max-idle="100000"/>
                        </local-cache>
                        <local-cache name="timestamps"/>
                    </cache-container>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:io:3.0">
                    <worker name="default"/>
                    <buffer-pool name="default"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:jaxrs:1.0"/>
                <subsystem xmlns="urn:jboss:domain:jca:5.0">
                    <archive-validation enabled="true" fail-on-error="true" fail-on-warn="false"/>
                    <bean-validation enabled="true"/>
                    <default-workmanager>
                        <short-running-threads>
                            <core-threads count="50"/>
                            <queue-length count="50"/>
                            <max-threads count="50"/>
                            <keepalive-time time="10" unit="seconds"/>
                        </short-running-threads>
                        <long-running-threads>
                            <core-threads count="50"/>
                            <queue-length count="50"/>
                            <max-threads count="50"/>
                            <keepalive-time time="10" unit="seconds"/>
                        </long-running-threads>
                    </default-workmanager>
                    <cached-connection-manager/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:jpa:1.1">
                    <jpa default-datasource="" default-extended-persistence-inheritance="DEEP"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:jsf:1.1"/>
                <subsystem xmlns="urn:jboss:domain:mail:3.0">
                    <mail-session name="default" jndi-name="java:jboss/mail/Default">
                        <smtp-server outbound-socket-binding-ref="mail-smtp"/>
                    </mail-session>
                    <mail-session name="java:/EjbcaMail" jndi-name="java:/EjbcaMail" from="noreply@mymail">
                        <smtp-server outbound-socket-binding-ref="ejbca-mail-smtp" tls="true" username="smtpuser" password="smtppassword"/>
                    </mail-session>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:naming:2.0">
                    <remote-naming/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:remoting:4.0">
                    <http-connector name="http-remoting-connector" connector-ref="remoting" security-realm="ApplicationRealm"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:request-controller:1.0"/>
                <subsystem xmlns="urn:jboss:domain:resource-adapters:5.0"/>
                <subsystem xmlns="urn:jboss:domain:security:2.0">
                    <security-domains>
                        <security-domain name="other" cache-type="default">
                            <authentication>
                                <login-module code="Remoting" flag="optional">
                                    <module-option name="password-stacking" value="useFirstPass"/>
                                </login-module>
                                <login-module code="RealmDirect" flag="required">
                                    <module-option name="password-stacking" value="useFirstPass"/>
                                </login-module>
                            </authentication>
                        </security-domain>
                        <security-domain name="jboss-web-policy" cache-type="default">
                            <authorization>
                                <policy-module code="Delegating" flag="required"/>
                            </authorization>
                        </security-domain>
                        <security-domain name="jaspitest" cache-type="default">
                            <authentication-jaspi>
                                <login-module-stack name="dummy">
                                    <login-module code="Dummy" flag="optional"/>
                                </login-module-stack>
                                <auth-module code="Dummy"/>
                            </authentication-jaspi>
                        </security-domain>
                        <security-domain name="jboss-ejb-policy" cache-type="default">
                            <authorization>
                                <policy-module code="Delegating" flag="required"/>
                            </authorization>
                        </security-domain>
                    </security-domains>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:security-manager:1.0">
                    <deployment-permissions>
                        <maximum-set>
                            <permission class="java.security.AllPermission"/>
                        </maximum-set>
                    </deployment-permissions>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:transactions:5.0">
                    <core-environment node-identifier="${jboss.tx.node.id:1}">
                        <process-id>
                            <uuid/>
                        </process-id>
                    </core-environment>
                    <recovery-environment socket-binding="txn-recovery-environment" status-socket-binding="txn-status-manager"/>
                    <object-store path="tx-object-store" relative-to="jboss.server.data.dir"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:undertow:7.0" default-server="default-server" default-virtual-host="default-host" default-servlet-container="default" default-security-domain="other">
                    <buffer-cache name="default"/>
                    <server name="default-server">
                        <ajp-listener name="ajp-listener" socket-binding="ajp" enabled="true" scheme="https"/>
                        <http-listener name="remoting" socket-binding="remoting" enable-http2="true"/>
                        <http-listener name="http" socket-binding="http" redirect-socket="httpspriv"/>
                        <https-listener name="httpspub" socket-binding="httpspub" max-parameters="2048" ssl-context="httpspub"/>
                        <https-listener name="httpspriv" socket-binding="httpspriv" max-parameters="2048" ssl-context="httpspriv"/>
                        <host name="default-host" alias="localhost">
                            <filter-ref name="redirect-to-app" predicate="method(GET) and not path-prefix('/ejbca/','/crls','/certificates','/.well-known/') and not equals({%{LOCAL_PORT}, 4447})"/>
                            <filter-ref name="crl-rewrite" predicate="method(GET) and regex('/crls/(.*)')"/>
                            <http-invoker security-realm="ApplicationRealm"/>
                        </host>
                    </server>
                    <servlet-container name="default">
                        <jsp-config/>
                        <websockets/>
                    </servlet-container>
                    <filters>
                        <rewrite name="redirect-to-app" target="/ejbca/" redirect="true"/>
                        <rewrite name="crl-rewrite" target="/ejbca/publicweb/crls/$${1}"/>
                    </filters>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:webservices:2.0">
                    <modify-wsdl-address>true</modify-wsdl-address>
                    <wsdl-host>jbossws.undefined.host</wsdl-host>
                    <endpoint-config name="Standard-Endpoint-Config"/>
                    <endpoint-config name="Recording-Endpoint-Config">
                        <pre-handler-chain name="recording-handlers" protocol-bindings="##SOAP11_HTTP ##SOAP11_HTTP_MTOM ##SOAP12_HTTP ##SOAP12_HTTP_MTOM">
                            <handler name="RecordingHandler" class="org.jboss.ws.common.invocation.RecordingServerHandler"/>
                        </pre-handler-chain>
                    </endpoint-config>
                    <client-config name="Standard-Client-Config"/>
                </subsystem>
                <subsystem xmlns="urn:jboss:domain:weld:4.0"/>
            </profile>
            <interfaces>
                <interface name="management">
                    <inet-address value="${jboss.bind.address.management:127.0.0.1}"/>
                </interface>
                <interface name="public">
                    <inet-address value="${jboss.bind.address:127.0.0.1}"/>
                </interface>
                <interface name="http">
                    <inet-address value="0.0.0.0"/>
                </interface>
                <interface name="httpspub">
                    <inet-address value="0.0.0.0"/>
                </interface>
                <interface name="httpspriv">
                    <inet-address value="0.0.0.0"/>
                </interface>
            </interfaces>
            <socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}">
                <socket-binding name="management-http" interface="management" port="${jboss.management.http.port:9990}"/>
                <socket-binding name="management-https" interface="management" port="${jboss.management.https.port:9993}"/>
                <socket-binding name="ajp" port="${jboss.ajp.port:8009}"/>
                <socket-binding name="txn-recovery-environment" port="4712"/>
                <socket-binding name="txn-status-manager" port="4713"/>
                <socket-binding name="remoting" interface="management" port="4447"/>
                <socket-binding name="http" interface="http" port="8080"/>
                <socket-binding name="httpspub" interface="httpspub" port="8442"/>
                <socket-binding name="httpspriv" interface="httpspriv" port="8443"/>
                <outbound-socket-binding name="mail-smtp">
                    <remote-destination host="localhost" port="25"/>
                </outbound-socket-binding>
                <outbound-socket-binding name="ejbca-mail-smtp">
                    <remote-destination host="my.mail.server" port="993"/>
                </outbound-socket-binding>
            </socket-binding-group>
        </server>

    kind: ConfigMap
    metadata:
      name: wildfly-config-${APP_NAME}

######


  parameters:
    - name: APP_NAME
      displayName: Nombre del microservicio
      value: 'ejbca-ce'
      required: true
    - name: REPO_GIT
      displayName: Repositorio git donde se encuentra la aplicacion
      value: "https://github.com/mvilche/ejbca-ce.git"
      required: true
    - name: BRANCH_GIT
      displayName: Nombre del branch del repositorio
      value: "master"
      required: true
    - name: POSTGRES_USER
      displayName: Postgres usuario
      value: ""
      required: true      
    - name: POSTGRES_HOST
      displayName: Postgres host
      value: ""
      required: true
    - name: POSTGRES_PORT
      displayName: Puerto postgres
      value: "5432"
      required: true
    - name: POSTGRES_PASSWORD
      displayName: Password base de datos
      value: ""
      required: true
    - name: POSTGRES_DATABASE
      displayName: Nombre del base de datos
      value: "ejbca"
      required: true      
